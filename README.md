重构：改善既有代码的设计
-----------------------

重构：对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。

重构：使用一系列重构手法，在不改变软件可观察行为的前提下，调整其结构。

# Tips
- 如果你发现自己需要为程序添加一个特性，而代码结构使你无法很方便地达成目的，那就先重构那个程序，使特性的添加比较容易进行，然后再添加特性
- 重构的第一步：为即将修改的代码建立一组可靠的测试环境。重构之前，首先检查自己是否有一套可靠的测试机制。这些测试必须有自我检验能力
- 重构技术就是以微小的步伐修改程序。如果你发现错误，很容易便可发现它。
- 任何一个傻瓜都能写出计算机可以理解的代码。唯有写出人类容易理解的代码，才是优秀的程序员。更改变量名称，提高代码清晰度。代码应该表现自己的目的
- 尽量去除一些无意义的临时变量，临时变量往往引发问题，会导致大量参数被传来传去，很容易跟丢它们，尤其在长长的函数中
- 两顶帽子：重构时应该把时间分配给两种行为：添加新功能和重构。添加新功能不能修改既有代码，只添加新功能；重构不能再添加新功能，只管改进程序结构，此时也不应添加任何测试
- 代码结构的流失是累积性的。越难看出代码所代表的设计意图，就越难保护其中的设计
- 消除重复代码：代码越多，正确的修改就越困难
- "准确说出我想要的"
- 重构使代码更容易理解和阅读。重构可以帮助我们写出更强健的代码。重构帮助我们快速地开发程序
- 三次法则：事不过三，三则重构
    - 第一次做某件事时只管去做
    - 第二次做类似的事情就会产生反感，但无论如何还是可以去做
    - 第三次再做类似的事情，就应该重构
- 重构时机：
    - 添加功能时重构
    - 修补错误时重构：如果收到一份错误报告，这就是重构的信号
    - 复审代码时重构
- 难以阅读的代码，难以修改
- 逻辑重复的代码，难以修改
- 添加新行为时需要修改已有代码的程序，难以修改
- 带复杂条件逻辑的程序，难以修改
- 好程序的特性：
    - 容易阅读
    - 所有逻辑都只在唯一地点指定
    - 新的改动不会危及现有行为
    - 尽可能简单表达条件逻辑
- 计算机是这样一门科学：它相信所有问题都可以通过增加一个间接层来解决
    - 间接层是一把双刃剑
    - 允许逻辑共享
    - 分开解释意图和实现
    - 隔离变化
    - 封装条件逻辑
    - 间接层可能导致对象过多
- 重构的难题
    - 数据库：在对象模型和数据库模型之间插入一个分隔层，隔离两个模型各自的变化
    - 修改接口：如何面对那些必须修改"已发布"接口（找不到，即使找到也不能修改的接口）的重构手法？
        - 让旧接口调用新接口。当你要修改某个函数名称时，请留下旧函数，让它调用新函数。**千万不要复制函数实现，它会让你陷入重复代码的泥淖中难以自拔**
        - 除非真有必要，不要发布接口。改版代码所有权政策，让每个人都可以修改别人的代码，以适应接口的改动
- 不要过早发布接口。请修改你的代码所有权政策，使重构更顺畅
- 何时不应该重构
    - 有时候重新编写代码比重构还简单时，就不应该重构。重写而非重构的一个清楚讯号就是：现有代码根本不能正常运作。重构之前，代码必须起码能够在大部分情况下正常运作
    - 将"大块头"重构为良好的小组件，然后可以逐一对组件做出"重构或重建"的决定
    - 项目已近最后期限，应该避免重构
- 重构可以带来更简单的设计，同时又不损失灵活性，这降低了设计过程的难度，减轻了设计压力
- 哪怕你完全了解系统，也请实际度量它的性能，不要臆测。臆测会让你学到一些东西，但十有八九是错的
- 编写快速软件的秘密就是：首先写出可调的软件，然后调整它以求获得足够速度
- 编写快速软件的方法：
    - 时间预算法：给每个组件预先分配一定的资源：时间和执行轨迹
    - 持续关注法：在任何时间做任何事情都要设法保持系统的高性能
    - 利用统计数据：编写程序时不对性能投以特别的关注，直至进入性能优化阶段
- 代码的坏味道
    - 重复代码
        - Extract Method：提炼出重复代码
        - Pull Up Method：将方法推入超类
        - Form Template Method：构建模板方法
        - Substitute Algorithm：替换算法
        - Extract Class：提炼出类
    - 过长函数
        - 让小函数容易理解的关键是有一个好名字
        - 每当感觉需要以注释来说明点什么的时候，我们就把需要说明的东西写进一个独立函数中，并以其用途（而非实现方法）命名
        - 关键不在于函数的长度，而在于函数"做什么"和"如何做"之间的语义距离
        - Extract Method
        - Replace Temp With Query 消除临时元素
        - Introduce Parameter Object 和 Preserve Whole Object 可以将过长的参数列变得简洁一些
        - Replace Method With Method Object
        - 寻找注释：如果代码前方有一行注释，就是在提醒你可以将这段代码替换为一个函数，而且可以在注释的基础上给这个函数命名。就算只有一行代码，如果需要以注释来说明，那也值得将它提炼到独立的函数中。
        - 条件表达式和循环常常也是提炼的信号，可以使用 Decompose Conditional 处理条件表达式
        - 循环应该将循环和其内部代码提炼到一个独立的函数中
    - 过大的类
        - Extract Class
        - Extract Subclass
        - 先确定客户端如何使用它们，然后运用 Extract Interface 为每一种使用方式提炼出一个接口
        - Duplicate Observed Data
    - 过长参数列
        - 使用对象
        - Replace Parameter with Method
        - Preserve Whole Object：将来自同一个对象的一堆数据收集起来，并以该对象替换它们
        - Introduce Parameter Object：构造参数对象
        - 例外：有时候不希望造成"被调用对象"与"较大对象"间的某种依赖关系，这时候将数据从对象中拆解出来单独作为参数，也是合理的。
    - 发散式变化
        -